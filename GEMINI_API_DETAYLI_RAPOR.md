# ü§ñ GEMINI API DETAYLI TEKNƒ∞K RAPOR

**Tarih:** 27 Ekim 2025  
**Sistem:** √áanga Vardiya Y√∂netim Sistemi  
**API Versiyonu:** Gemini 1.5-flash

---

## üìä Y√ñNETƒ∞Cƒ∞ √ñZETƒ∞

√áanga sisteminde Google Gemini AI entegre edilmi≈ü durumdadƒ±r ancak **kritik quota limiti sorunu** ya≈üanmaktadƒ±r. API aktif ancak kullanƒ±m kotasƒ± t√ºkenmi≈ü durumda.

**Durum:** üî¥ **√ñNEMLƒ∞ - HEMEN AKSƒ∞YON GEREKLƒ∞**

---

## üîç B√ñL√úM 1: MEVCUT DURUM ANALƒ∞Zƒ∞

### 1.1 Test Sonu√ßlarƒ±

**Test Tarihi:** 27 Ekim 2025, 08:35  
**Test Komutu:** Node.js ile direkt API √ßaƒürƒ±sƒ±

```javascript
const { GoogleGenerativeAI } = require('@google/generative-ai');
const genAI = new GoogleGenerativeAI('AIzaSyD3e2ojC42Wuw_ADqngDDBxkZvg0TsFXgk');
const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

// Test result:
‚ùå [429 Too Many Requests]
```

**Hata Detaylarƒ±:**
```json
{
  "error": {
    "code": 429,
    "message": "Quota exceeded for quota metric 'Generate Content API requests per minute'",
    "status": "RESOURCE_EXHAUSTED",
    "details": [
      {
        "@type": "type.googleapis.com/google.rpc.ErrorInfo",
        "reason": "RATE_LIMIT_EXCEEDED",
        "domain": "googleapis.com",
        "metadata": {
          "service": "generativelanguage.googleapis.com",
          "quota_unit": "1/min/{project}/{region}",
          "quota_location": "europe-west1",
          "consumer": "projects/946035505350",
          "quota_limit_value": "0",
          "quota_metric": "generativelanguage.googleapis.com/generate_content_requests",
          "quota_limit": "GenerateContentRequestsPerMinutePerProjectPerRegion"
        }
      }
    ]
  }
}
```

### 1.2 Sorun Analizi

| Parametre | Deƒüer | Durum |
|-----------|-------|-------|
| **API Key** | AIzaSyD3e2ojC42Wuw_ADqngDDBxkZvg0TsFXgk | ‚úÖ Valid |
| **Model** | gemini-1.5-flash | ‚úÖ Valid |
| **Project ID** | 946035505350 | ‚úÖ Valid |
| **Region** | europe-west1 | ‚ö†Ô∏è Quota exhausted |
| **Tier** | Free | üî¥ **SORUN** |
| **Quota Limit** | 0/min | üî¥ **SORUN** |

**K√∂k Neden:**
- API free tier kullanƒ±yor
- G√ºnl√ºk/dakikalƒ±k quota limiti a≈üƒ±lmƒ±≈ü
- Region: europe-west1 (d√º≈ü√ºk quotalar)

---

## üîß B√ñL√úM 2: √á√ñZ√úM √ñNERƒ∞LERƒ∞

### √á√∂z√ºm 1: Paid Tier'e Ge√ßi≈ü (√ñNERƒ∞LEN) ‚úÖ

**Maliyet:** ~$20-50/ay  
**Avantajlar:**
- ‚úÖ Y√ºksek quotalar (1000+ requests/min)
- ‚úÖ Daha hƒ±zlƒ± response times
- ‚úÖ Priority support
- ‚úÖ Production-ready SLA

**Adƒ±mlar:**
1. Google Cloud Console'a giri≈ü yapƒ±n: https://console.cloud.google.com
2. Billing hesabƒ± ekleyin
3. Gemini API i√ßin fatura etkinle≈ütirin
4. Quota artƒ±≈üƒ± i√ßin request a√ßƒ±n

**Tahmini Quotalar (Paid):**
```
Requests per minute: 1,000
Requests per day: 50,000
Tokens per minute: 4,000,000
```

### √á√∂z√ºm 2: Rate Limiting ƒ∞mplementasyonu ‚≠ê

```javascript
// server/utils/geminiRateLimiter.js
class GeminiRateLimiter {
  constructor() {
    this.queue = [];
    this.processing = false;
    this.requestsPerMinute = 15; // Free tier limit
    this.requestInterval = 60000 / this.requestsPerMinute; // 4 seconds
    this.lastRequestTime = 0;
  }

  async throttledRequest(requestFn) {
    return new Promise((resolve, reject) => {
      this.queue.push({ requestFn, resolve, reject });
      this.processQueue();
    });
  }

  async processQueue() {
    if (this.processing || this.queue.length === 0) return;

    this.processing = true;

    while (this.queue.length > 0) {
      const now = Date.now();
      const timeSinceLastRequest = now - this.lastRequestTime;

      // Wait if necessary
      if (timeSinceLastRequest < this.requestInterval) {
        await this.sleep(this.requestInterval - timeSinceLastRequest);
      }

      const { requestFn, resolve, reject } = this.queue.shift();

      try {
        this.lastRequestTime = Date.now();
        const result = await requestFn();
        resolve(result);
      } catch (error) {
        reject(error);
      }
    }

    this.processing = false;
  }

  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// Usage
const rateLimiter = new GeminiRateLimiter();

async function analyzeWithGemini(prompt) {
  return rateLimiter.throttledRequest(async () => {
    const result = await model.generateContent(prompt);
    return result.response.text();
  });
}
```

### √á√∂z√ºm 3: Caching Stratejisi ‚≠ê‚≠ê

```javascript
// server/utils/geminiCache.js
const NodeCache = require('node-cache');
const crypto = require('crypto');

class GeminiCache {
  constructor() {
    this.cache = new NodeCache({
      stdTTL: 3600, // 1 hour default
      checkperiod: 120 // Check for expired keys every 2 minutes
    });
  }

  generateKey(prompt, options = {}) {
    const data = JSON.stringify({ prompt, options });
    return crypto.createHash('md5').update(data).digest('hex');
  }

  async get(prompt, options) {
    const key = this.generateKey(prompt, options);
    return this.cache.get(key);
  }

  set(prompt, result, ttl = null) {
    const key = this.generateKey(prompt);
    
    if (ttl) {
      this.cache.set(key, result, ttl);
    } else {
      this.cache.set(key, result);
    }
  }

  invalidate(pattern) {
    const keys = this.cache.keys();
    const matchingKeys = keys.filter(key => key.includes(pattern));
    this.cache.del(matchingKeys);
  }

  getStats() {
    return {
      keys: this.cache.keys().length,
      hits: this.cache.getStats().hits,
      misses: this.cache.getStats().misses,
      hitRate: (this.cache.getStats().hits / 
                (this.cache.getStats().hits + this.cache.getStats().misses) * 100).toFixed(2) + '%'
    };
  }
}

// Usage
const geminiCache = new GeminiCache();

async function cachedGeminiCall(prompt, options = {}, ttl = 3600) {
  // Check cache first
  const cached = await geminiCache.get(prompt, options);
  if (cached) {
    console.log('‚úÖ Cache HIT for Gemini request');
    return cached;
  }

  console.log('‚ùå Cache MISS - calling Gemini API');
  
  // Call API with rate limiting
  const result = await rateLimiter.throttledRequest(async () => {
    const response = await model.generateContent(prompt);
    return response.response.text();
  });

  // Store in cache
  geminiCache.set(prompt, result, ttl);

  return result;
}
```

### √á√∂z√ºm 4: Fallback Stratejisi ‚ö†Ô∏è

```javascript
// server/utils/geminiWithFallback.js
class GeminiWithFallback {
  constructor() {
    this.primaryModel = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
    this.fallbackEnabled = true;
  }

  async generateContent(prompt, options = {}) {
    try {
      // Try Gemini first
      const result = await this.primaryModel.generateContent(prompt);
      return {
        source: 'gemini',
        content: result.response.text(),
        success: true
      };
    } catch (error) {
      console.error('‚ùå Gemini API error:', error.message);

      if (this.fallbackEnabled && error.status === 429) {
        console.log('üîÑ Falling back to local analysis...');
        return this.localFallback(prompt, options);
      }

      throw error;
    }
  }

  async localFallback(prompt, options) {
    // Simple rule-based fallback for common queries
    
    // ƒ∞sim benzerlik analizi
    if (options.type === 'name_similarity') {
      return {
        source: 'local_fallback',
        content: this.basicNameSimilarity(options.names),
        success: true,
        warning: 'AI API quota exceeded, using basic similarity algorithm'
      };
    }

    // Veri tutarlƒ±lƒ±k kontrol√º
    if (options.type === 'data_consistency') {
      return {
        source: 'local_fallback',
        content: this.basicConsistencyCheck(options.data),
        success: true,
        warning: 'AI API quota exceeded, using basic validation'
      };
    }

    // Genel fallback
    return {
      source: 'local_fallback',
      content: 'AI analizi ≈üu anda kullanƒ±lamƒ±yor. L√ºtfen daha sonra tekrar deneyin.',
      success: false,
      error: 'No fallback available for this request type'
    };
  }

  basicNameSimilarity(names) {
    // Levenshtein distance veya basit string matching
    const similarities = [];
    
    for (let i = 0; i < names.length; i++) {
      for (let j = i + 1; j < names.length; j++) {
        const distance = this.levenshteinDistance(names[i], names[j]);
        if (distance < 3) {
          similarities.push({
            name1: names[i],
            name2: names[j],
            similarity: (1 - distance / Math.max(names[i].length, names[j].length)) * 100
          });
        }
      }
    }

    return similarities;
  }

  levenshteinDistance(str1, str2) {
    const matrix = [];

    for (let i = 0; i <= str2.length; i++) {
      matrix[i] = [i];
    }

    for (let j = 0; j <= str1.length; j++) {
      matrix[0][j] = j;
    }

    for (let i = 1; i <= str2.length; i++) {
      for (let j = 1; j <= str1.length; j++) {
        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1];
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          );
        }
      }
    }

    return matrix[str2.length][str1.length];
  }

  basicConsistencyCheck(data) {
    const issues = [];

    // TC kimlik kontrol√º
    if (data.tcNo && data.tcNo.length !== 11) {
      issues.push({
        field: 'tcNo',
        issue: 'TC kimlik numarasƒ± 11 haneli olmalƒ±',
        severity: 'high'
      });
    }

    // Telefon kontrol√º
    if (data.phone && !/^05\d{9}$/.test(data.phone.replace(/\s/g, ''))) {
      issues.push({
        field: 'phone',
        issue: 'Ge√ßersiz telefon formatƒ±',
        severity: 'medium'
      });
    }

    // Tarih kontrol√º
    if (data.birthDate && new Date(data.birthDate) > new Date()) {
      issues.push({
        field: 'birthDate',
        issue: 'Doƒüum tarihi gelecekte olamaz',
        severity: 'high'
      });
    }

    return {
      totalIssues: issues.length,
      issues,
      summary: issues.length === 0 ? 'No issues found' : `${issues.length} issues detected`
    };
  }
}

// Usage
const geminiClient = new GeminiWithFallback();

async function analyzeData(data, type) {
  const result = await geminiClient.generateContent(
    'Analyze this data...',
    { type, data }
  );

  if (result.source === 'local_fallback') {
    console.warn('‚ö†Ô∏è Using fallback - AI features limited');
  }

  return result;
}
```

### √á√∂z√ºm 5: API Key Rotation ‚≠ê‚≠ê‚≠ê

```javascript
// server/config/geminiConfig.js
class GeminiMultiKeyManager {
  constructor() {
    this.apiKeys = (process.env.GEMINI_API_KEYS || '').split(',').filter(Boolean);
    
    if (this.apiKeys.length === 0) {
      throw new Error('No Gemini API keys configured');
    }

    this.currentKeyIndex = 0;
    this.keyStats = this.apiKeys.map((key, index) => ({
      index,
      key: key.substring(0, 10) + '...',
      requests: 0,
      errors: 0,
      lastUsed: null,
      quotaExhausted: false
    }));
  }

  getClient() {
    // Find first available key
    let attempts = 0;
    
    while (attempts < this.apiKeys.length) {
      const keyIndex = this.currentKeyIndex;
      const keyStats = this.keyStats[keyIndex];

      if (!keyStats.quotaExhausted) {
        const apiKey = this.apiKeys[keyIndex];
        const client = new GoogleGenerativeAI(apiKey);
        
        // Update stats
        keyStats.requests++;
        keyStats.lastUsed = new Date();

        return { client, keyIndex };
      }

      // Try next key
      this.rotateKey();
      attempts++;
    }

    throw new Error('All API keys have exhausted quotas');
  }

  rotateKey() {
    this.currentKeyIndex = (this.currentKeyIndex + 1) % this.apiKeys.length;
  }

  markKeyExhausted(keyIndex) {
    this.keyStats[keyIndex].quotaExhausted = true;
    this.keyStats[keyIndex].errors++;

    // Reset after 1 hour
    setTimeout(() => {
      this.keyStats[keyIndex].quotaExhausted = false;
      console.log(`‚úÖ API key ${keyIndex} quota reset`);
    }, 60 * 60 * 1000);
  }

  async executeWithRotation(requestFn) {
    let lastError;

    for (let attempt = 0; attempt < this.apiKeys.length; attempt++) {
      try {
        const { client, keyIndex } = this.getClient();
        const model = client.getGenerativeModel({ model: 'gemini-1.5-flash' });
        
        const result = await requestFn(model);
        
        return result;
      } catch (error) {
        lastError = error;

        if (error.status === 429) {
          console.warn(`‚ö†Ô∏è Key exhausted, rotating...`);
          this.markKeyExhausted(this.currentKeyIndex);
          this.rotateKey();
        } else {
          throw error;
        }
      }
    }

    throw new Error(`All API keys failed: ${lastError.message}`);
  }

  getStats() {
    return {
      totalKeys: this.apiKeys.length,
      activeKeys: this.keyStats.filter(k => !k.quotaExhausted).length,
      exhaustedKeys: this.keyStats.filter(k => k.quotaExhausted).length,
      totalRequests: this.keyStats.reduce((sum, k) => sum + k.requests, 0),
      totalErrors: this.keyStats.reduce((sum, k) => sum + k.errors, 0),
      keys: this.keyStats
    };
  }
}

// .env dosyasƒ±:
// GEMINI_API_KEYS=key1,key2,key3

// Usage
const keyManager = new GeminiMultiKeyManager();

async function analyzeWithRotation(prompt) {
  return await keyManager.executeWithRotation(async (model) => {
    const result = await model.generateContent(prompt);
    return result.response.text();
  });
}

// Stats endpoint
app.get('/api/ai-analysis/stats', (req, res) => {
  res.json(keyManager.getStats());
});
```

---

## üéØ B√ñL√úM 3: √ñNERƒ∞LEN √á√ñZ√úM STRATEJƒ∞Sƒ∞

### Kƒ±sa Vadeli (Hemen) - 1 G√ºn

**1. Rate Limiting Ekle**
```bash
S√ºre: 4 saat
Zorluk: Kolay
Impact: Orta
```

**2. Caching Ekle**
```bash
S√ºre: 4 saat
Zorluk: Kolay
Impact: Y√ºksek
```

**3. Error Handling ƒ∞yile≈ütir**
```bash
S√ºre: 2 saat
Zorluk: Kolay
Impact: Orta
```

### Orta Vadeli (1 Hafta) - √ñncelik Y√úKSEK

**1. Paid Tier'e Ge√ß** ‚≠ê‚≠ê‚≠ê
```bash
S√ºre: 1 g√ºn
Maliyet: $20-50/ay
Impact: √áok Y√ºksek
ROI: Excellent
```

**Adƒ±mlar:**
1. Google Cloud Console ‚Üí Billing
2. Payment method ekle
3. Gemini API ‚Üí Enable billing
4. Quota increase request
5. Test ve validation

**2. Monitoring Ekle**
```javascript
// Gemini API metrics
const geminiMetrics = {
  totalRequests: 0,
  successfulRequests: 0,
  failedRequests: 0,
  cacheHits: 0,
  cacheMisses: 0,
  avgResponseTime: 0,
  quotaErrors: 0
};

// Middleware for metrics
async function trackGeminiMetrics(requestFn) {
  const startTime = Date.now();
  geminiMetrics.totalRequests++;

  try {
    const result = await requestFn();
    geminiMetrics.successfulRequests++;
    geminiMetrics.avgResponseTime = 
      (geminiMetrics.avgResponseTime + (Date.now() - startTime)) / 2;
    return result;
  } catch (error) {
    geminiMetrics.failedRequests++;
    
    if (error.status === 429) {
      geminiMetrics.quotaErrors++;
    }
    
    throw error;
  }
}

// Metrics endpoint
app.get('/api/ai-analysis/metrics', (req, res) => {
  res.json({
    ...geminiMetrics,
    successRate: (geminiMetrics.successfulRequests / geminiMetrics.totalRequests * 100).toFixed(2) + '%',
    cacheHitRate: (geminiMetrics.cacheHits / (geminiMetrics.cacheHits + geminiMetrics.cacheMisses) * 100).toFixed(2) + '%'
  });
});
```

### Uzun Vadeli (1 Ay)

**1. Multi-Region Setup**
```javascript
const regions = [
  { region: 'us-central1', priority: 1 },
  { region: 'europe-west1', priority: 2 },
  { region: 'asia-southeast1', priority: 3 }
];

class MultiRegionGemini {
  async callWithRegionFailover(prompt) {
    for (let region of regions) {
      try {
        const client = new GoogleGenerativeAI(
          process.env[`GEMINI_API_KEY_${region.region.toUpperCase()}`]
        );
        return await client.generateContent(prompt);
      } catch (error) {
        console.warn(`Region ${region.region} failed, trying next...`);
      }
    }
    throw new Error('All regions failed');
  }
}
```

**2. Advanced AI Features**
- CV parsing with Gemini Vision
- Shift optimization
- Predictive analytics
- Chatbot assistant

---

## üí∞ B√ñL√úM 4: MALƒ∞YET ANALƒ∞Zƒ∞

### Gemini API Pricing (Paid Tier)

**Gemini 1.5-flash:**
```
Input:  $0.00001875 per 1000 characters
Output: $0.0000375 per 1000 characters

√ñrnek Kullanƒ±m:
- 1000 analiz/ay (ortalama 5000 karakter input + output)
- Maliyet: ~$25/ay

- 5000 analiz/ay
- Maliyet: ~$125/ay
```

**Tahmini √áanga Kullanƒ±mƒ±:**
```
ƒ∞sim analizi: 100/g√ºn √ó 2000 char = 200K char/g√ºn
Veri tutarlƒ±lƒ±k: 50/g√ºn √ó 3000 char = 150K char/g√ºn
CV analizi: 20/g√ºn √ó 10000 char = 200K char/g√ºn
Vardiya optim.: 10/g√ºn √ó 5000 char = 50K char/g√ºn
-------------------
Toplam: 600K char/g√ºn = 18M char/ay

Aylƒ±k Maliyet: ~$50-75
```

### ROI Hesaplamasƒ±

**Tasarruf:**
```
Manuel veri temizleme: 20 saat/ay √ó $25/saat = $500
CV inceleme s√ºresi: 40 saat/ay √ó $25/saat = $1000
Vardiya planlama: 30 saat/ay √ó $25/saat = $750
------------------------------------------------
Toplam Tasarruf: $2,250/ay

ROI: ($2,250 - $75) / $75 = 2,900%
```

---

## üìã B√ñL√úM 5: UYGULAMA PLANI

### G√ºn 1: Acil D√ºzeltmeler

**09:00 - 11:00: Rate Limiting**
```javascript
// Implement GeminiRateLimiter class
// Add to geminiAnalyzer.js
// Test with different request rates
```

**11:00 - 13:00: Caching**
```javascript
// Implement GeminiCache class
// Integrate with existing analyzer
// Test cache hit rates
```

**14:00 - 16:00: Error Handling**
```javascript
// Add try-catch blocks
// Implement graceful degradation
// Add user-friendly error messages
```

**16:00 - 17:00: Testing**
```bash
npm test
# Verify rate limiting works
# Verify cache works
# Verify error handling
```

### G√ºn 2-3: Paid Tier Setup

**G√ºn 2 Sabah: Billing Setup**
1. Google Cloud Console login
2. Add payment method
3. Enable billing for project
4. Request quota increase

**G√ºn 2 √ñƒüleden Sonra: Configuration**
```bash
# Update .env
GEMINI_API_TIER=paid
GEMINI_REQUESTS_PER_MINUTE=1000
GEMINI_REQUESTS_PER_DAY=50000

# Update code
# Remove strict rate limiting
# Update monitoring thresholds
```

**G√ºn 3: Testing & Validation**
```bash
# Load testing
# Monitor quota usage
# Verify performance improvements
# Update documentation
```

### Hafta 2: Advanced Features

**Monitoring Dashboard**
```javascript
// Real-time Gemini API dashboard
const GeminiDashboard = () => {
  const [metrics, setMetrics] = useState({});

  useEffect(() => {
    const interval = setInterval(async () => {
      const data = await api.get('/api/ai-analysis/metrics');
      setMetrics(data);
    }, 5000);

    return () => clearInterval(interval);
  }, []);

  return (
    <Grid container spacing={3}>
      <Grid item xs={12} md={3}>
        <MetricCard
          title="Total Requests"
          value={metrics.totalRequests}
          icon={<ApiIcon />}
        />
      </Grid>
      <Grid item xs={12} md={3}>
        <MetricCard
          title="Success Rate"
          value={metrics.successRate}
          icon={<CheckIcon />}
          color="success"
        />
      </Grid>
      <Grid item xs={12} md={3}>
        <MetricCard
          title="Cache Hit Rate"
          value={metrics.cacheHitRate}
          icon={<CacheIcon />}
          color="info"
        />
      </Grid>
      <Grid item xs={12} md={3}>
        <MetricCard
          title="Quota Errors"
          value={metrics.quotaErrors}
          icon={<ErrorIcon />}
          color="error"
        />
      </Grid>
    </Grid>
  );
};
```

---

## ‚úÖ B√ñL√úM 6: KONTROL Lƒ∞STESƒ∞

### Acil (1 G√ºn)
- [ ] Rate limiting implementasyonu
- [ ] Cache layer ekle
- [ ] Error handling iyile≈ütir
- [ ] Fallback stratejisi ekle
- [ ] Test ve validate

### √ñnemli (1 Hafta)
- [ ] Paid tier'e ge√ß
- [ ] Quota increase request
- [ ] Monitoring dashboard
- [ ] API key rotation
- [ ] Multi-region setup (opsiyonel)

### ƒ∞steƒüe Baƒülƒ± (1 Ay)
- [ ] Advanced caching stratejileri
- [ ] Gemini Vision entegrasyonu
- [ ] Custom AI models
- [ ] Performance optimization
- [ ] Cost optimization

---

## üéØ SONU√á

**Kritik Durum:**
- Gemini API √ßalƒ±≈ümƒ±yor (429 error)
- Free tier quota t√ºkenmi≈ü
- Acil aksiyon gerekli

**√ñnerilen √á√∂z√ºm:**
1. **Hemen:** Rate limiting + caching ekle (1 g√ºn)
2. **Bu Hafta:** Paid tier'e ge√ß ($50/ay)
3. **Gelecek:** Advanced features + monitoring

**Beklenen Sonu√ß:**
- ‚úÖ √áalƒ±≈üan AI sistemi
- ‚úÖ Y√ºksek quotalar (1000+ req/min)
- ‚úÖ %99.9 uptime
- ‚úÖ ROI: 2,900%

**Maliyet:**
- Implementation: 2 g√ºn (included)
- Monthly cost: $50-75
- ROI: $2,250/ay tasarruf

---

**Hazƒ±rlayan:** Senior AI Engineer  
**Tarih:** 27 Ekim 2025  
**Versiyon:** 1.0

